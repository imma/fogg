#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"
  source normalize

  export WORK="$(pwd)"

  rm module/fogg 2>/dev/null || true
  mkdir -p module/fogg
  compgen -A variable | grep '^_fogg_' | runmany 'a="$1"; nm="${!a}"; nm="${nm#*/fogg-}"; nm="${nm%_home}"; if test -f "${!a}/main.tf"; then ln -nfs "${!a}" "module/fogg/${nm}"; fi'

  mkdir -p bin
  for nm_org in "$@"; do
    # modules in each terraform config
    find "$nm_org" -name '*.tf' -o -name '*.tf.json' -o -name '*.tfvars' | perl -pe 's{[^/\s]+$}{}' | uniq | runmany 'cd ${WORK}/$1 && ln -nfs "$(git rev-parse --show-cdup)module" .'

    # bin/ service scripts
    (set +f; ls -d ${nm_org}/*/*/*/) | grep -v /module/ | runmany 'test -d "$1" && cd bin && ln -vnfs "$(which fogg-proxy-service)" $(echo $1 | cut -d/ -f2-4 | tr / -)'
  done
}

source sub "$BASH_SOURCE" "$@"
